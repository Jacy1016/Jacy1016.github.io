<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>地理位置</title>
    <url>/2020/03/09/%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE/</url>
    <content><![CDATA[<h3 id="获取地理位置"><a href="#获取地理位置" class="headerlink" title="获取地理位置"></a>获取地理位置</h3><h4 id="获取用户地理位置信息的前提是用户同意地理位置授权并打开手机的-GPS-定位，但是某些手机会出现定位不准的情况"><a href="#获取用户地理位置信息的前提是用户同意地理位置授权并打开手机的-GPS-定位，但是某些手机会出现定位不准的情况" class="headerlink" title="获取用户地理位置信息的前提是用户同意地理位置授权并打开手机的 GPS 定位，但是某些手机会出现定位不准的情况"></a>获取用户地理位置信息的前提是用户同意地理位置授权并打开手机的 GPS 定位，但是某些手机会出现定位不准的情况</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">getLoca: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span> &#123;</span><br><span class="line">    wx.getSetting(&#123;</span><br><span class="line">      success(res) &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.authSetting[<span class="string">"scope.userLocation"</span>]) &#123;</span><br><span class="line">          wx.getLocation(&#123;</span><br><span class="line">            type: <span class="string">'gcj02'</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">              <span class="comment">//将腾讯地图的坐标转为百度地图的坐标</span></span><br><span class="line">              <span class="keyword">var</span> x_pi = <span class="number">3.14159265358979324</span> * <span class="number">3000.0</span> / <span class="number">180.0</span>;</span><br><span class="line">              <span class="keyword">var</span> x = <span class="built_in">parseFloat</span>(res.longitude);</span><br><span class="line">              <span class="keyword">var</span> y = <span class="built_in">parseFloat</span>(res.latitude);</span><br><span class="line">              <span class="keyword">var</span> z = <span class="built_in">Math</span>.sqrt(x * x + y * y) + <span class="number">0.00002</span> * <span class="built_in">Math</span>.sin(y * x_pi);</span><br><span class="line">              <span class="keyword">var</span> theta = <span class="built_in">Math</span>.atan2(y, x) + <span class="number">0.000003</span> * <span class="built_in">Math</span>.cos(x * x_pi);</span><br><span class="line">              <span class="keyword">var</span> lng = z * <span class="built_in">Math</span>.cos(theta) + <span class="number">0.0065</span>;</span><br><span class="line">              <span class="keyword">var</span> lat = z * <span class="built_in">Math</span>.sin(theta) + <span class="number">0.006</span>;</span><br><span class="line">              that.globalData.latitude = lat.toFixed(<span class="number">6</span>);</span><br><span class="line">              that.globalData.longitude = lng.toFixed(<span class="number">6</span>);</span><br><span class="line">              reslove()</span><br><span class="line">            &#125;,</span><br><span class="line">            fail: <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">              reject(<span class="string">"获取地理位置失败，请打开GPS定位"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          reject()</span><br><span class="line">          wx.showModal(&#123;</span><br><span class="line">            title: <span class="string">'提示'</span>,</span><br><span class="line">            content: <span class="string">'需要您授权地理位置'</span>,</span><br><span class="line">            showCancel: <span class="literal">false</span>,</span><br><span class="line">            success: <span class="function"><span class="params">modalSuccess</span> =&gt;</span> &#123;</span><br><span class="line">              wx.openSetting(&#123;</span><br><span class="line">                success(settingdata) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (settingdata.authSetting[<span class="string">'scope.userLocation'</span>]) &#123;</span><br><span class="line">                    wx.showToast(&#123;</span><br><span class="line">                      title: <span class="string">'获取位置成功，请继续参与活动。'</span>,</span><br><span class="line">                      mask: <span class="literal">true</span>,</span><br><span class="line">                      icon: <span class="string">"none"</span>,</span><br><span class="line">                      duration: <span class="number">3000</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    wx.showToast(&#123;</span><br><span class="line">                      title: <span class="string">'获取位置失败。'</span>,</span><br><span class="line">                      mask: <span class="literal">true</span>,</span><br><span class="line">                      icon: <span class="string">"none"</span>,</span><br><span class="line">                      duration: <span class="number">3000</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                fail(err) &#123;</span><br><span class="line">                  <span class="built_in">console</span>.log(<span class="string">"err"</span>, err)</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">getLocaByNet: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 实例化腾讯地图API核心类  有调用次数限制</span></span><br><span class="line">  <span class="keyword">var</span> qqmapsdk = <span class="keyword">new</span> QQMapWX(&#123;</span><br><span class="line">    key: <span class="string">'123456789'</span> <span class="comment">// 必填</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 获取当前位置坐标</span></span><br><span class="line">  wx.getLocation(&#123;</span><br><span class="line">    type: <span class="string">'gcj02'</span>,</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">      that.globalData.latitude = res.latitude;</span><br><span class="line">      that.globalData.longitude = res.longitude;</span><br><span class="line">      <span class="comment">// 根据坐标获取当前位置名称 腾讯地图逆地址解析</span></span><br><span class="line">      qqmapsdk.reverseGeocoder(&#123;</span><br><span class="line">        location: &#123;</span><br><span class="line">          latitude: res.latitude,</span><br><span class="line">          longitude: res.longitude</span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">addressRes</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> city = addressRes.result.address_component.city; <span class="comment">//市</span></span><br><span class="line">          <span class="keyword">var</span> province = addressRes.result.address_component.province; <span class="comment">//省</span></span><br><span class="line">          &#125;,</span><br><span class="line">          fail: <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;&#125;,</span><br><span class="line">          complete: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">      fail: <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>微信小程序</category>
      </categories>
      <tags>
        <tag>微信小程序 授权 地理位置</tag>
      </tags>
  </entry>
</search>
